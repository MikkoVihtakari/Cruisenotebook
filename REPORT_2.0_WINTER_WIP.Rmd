---
title: |
  ![](HI logo farger engelsk){width=1in}  
  Winter survey 2020 R/V Johan Hjort
author: 'Report generated by: Johanna Fall'
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  pdf_document:
    extra_dependencies: flafter
    toc: yes
    toc_depth: 3
classoption: landscape
---
\fontsize{12}{18}
\selectfont

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 220, dev = "CairoPNG")
```

```{r load packages, echo=FALSE, message=FALSE, warning=FALSE}
#Load required packages
Packages <- c("plyr","tidyverse", "data.table", "XML", "reshape2", 
              "chron", "proj4", "readxl", "Cairo", "bookdown", "RstoxData")
invisible(lapply(X = Packages,FUN = library, character.only = TRUE))
```

\pagebreak

# Cruise tracks and stations

Cruise tracks from the position log with points indicating start positions for different sampling gear. The points are jittered slightly for better visual representation:

```{r plot cruise tracks and stations, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width= "75%", fig.align="center"}

# Get bathymetry data from file
bath1<-read_csv(file = "Data/GeoData/ETOPO1_nm4.csv")

# Define map extent and depth contours
Ylim<-c(70,76)        #latitude
Xlim<-c(8, 55)         #longitude
d.contours<-c(-100, -300,-500)   #Depth contours for plot with bathymetry

#reduce the resolution of depth contours (to increase speed when writing to file)
bath<-subset(bath1, bath1$y>(Ylim[1]-2) & (bath1$y<Ylim[2]+2) & bath1$ x>(Xlim[1]-2)& bath1$x<(Xlim[2]+2) & bath1$z<=(d.contours[1]+1500) & bath1$z>=(d.contours[length(d.contours)]-1500))

#create a list of the position files from the target directory
file_list <- list.files(path="Data/Track", pattern = ".csv")

#initiate a blank data frame, each iteration of the loop will append the data from the given file to this variable
dataset <- data.frame()

#set temporary working directory
setwd("Data/Track")

for (i in 1:length(file_list)){
  temp_data <- fread(file_list[i], stringsAsFactors = F,header = T, skip = 2,fill = T,strip.white = FALSE) #read in files using the fread function from the data.table package
  temp_data$Date <- strsplit(gsub(".csv", "", file_list[i]), "s")[[1]][2] #clean the data as needed, in this case I am creating a new column that indicates which date each file comes from
  #The latitude column is in format "DDMM.MMMM N"
  #The longitude column is in format "0DDMM.MMMM E"
  #Create new columns with lon and lat in decimal degrees
  temp_data <- temp_data %>% separate(Latitude, into = c("DD", "MM", "x1"), 
                                      sep = c(2,9), remove = F) %>% 
    separate(Longitude, into = c("x1.lon", "DD.lon", "MM.lon", "x2.lon"), 
             sep = c(1,3,10), remove = F)
  temp_data$DD <- as.numeric(temp_data$DD);temp_data$DD.lon <- as.numeric(temp_data$DD.lon)
  temp_data$MM <- as.numeric(temp_data$MM);temp_data$MM.lon <- as.numeric(temp_data$MM.lon)
  temp_data$Lat.dd <- temp_data$DD + temp_data$MM/60
  temp_data$Lon.dd <- temp_data$DD.lon + temp_data$MM.lon/60
  dataset <- rbindlist(list(dataset, temp_data), use.names = T, fill = T) #for each iteration, bind the new data to the building dataset
  rm(temp_data)
  }

#Name the gears
dataset$gear.text <- NA
dataset$gear.text[dataset$`Station type` == "Bottom trawl start"] <- "Bottom trawl"
dataset$gear.text[dataset$`Station type` == "Pelagic trawl start"] <- "Pelagic trawl"
dataset$gear.text[dataset$`Station type` %in% c("CTD with watersample start", "CTD start")] <- "CTD"
dataset$gear.text[dataset$`Station type` == "Håv-trekk stasjon.start"] <- "WP2"

#remove last two trawls - not part of official stations (sjøtest)
# dataset <- dataset %>% dplyr::filter(!Loc.St.No %in% c(624,625))

#Plot the cruise tracks and stations
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) +
  geom_point(data=dataset %>% dplyr::filter(is.na(gear.text)), aes(Lon.dd, Lat.dd, group = Date), alpha=0.2, colour="grey45", size=0.1, inherit.aes = F)+
  geom_jitter(data = dataset %>% dplyr::filter(!is.na(gear.text)), aes(Lon.dd, Lat.dd, color=gear.text), size = 2, shape = 6, inherit.aes = F, stroke = 0.75, width = 0.25)+
  scale_color_viridis_d(na.translate=F)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", color="Sampling gear")

```
\pagebreak
```{r read in trawl data, echo = FALSE, message=FALSE, results='hide', cache=FALSE}
#specify file path
tokt <- paste0("Data/Biotic/",list.files(path="Data/Biotic", pattern = ".xml"))

#read in with function ReadBiotic from RstoxData
dd<- ReadBiotic(tokt)

#Combine station and catch data
stasamp <- right_join(dd[[1]]$fishstation,dd[[1]]$catchsample) %>% mutate(cr.kg.nm=catchweight/distance) %>% mutate(cr.n.nm=catchcount/distance)

#Legg til geartype i tekstformat
stasamp$gear.text <- "Bottom trawl"
stasamp$gear.text[stasamp$gear %in% c("3513", "3514", "3592")] <- "Pelagic trawl"
```
# Sampling depth for trawl hauls  

`r length(unique(stasamp$station))` trawl hauls were taken during the survey, of which `r length(unique(stasamp$station[stasamp$gear.text == "Bottom trawl"]))` were bottom trawl, and `r length(unique(stasamp$station[stasamp$gear.text == "Pelagic trawl"]))` pelagic trawl. The trawl hauls covered a total distance of `r round((sum(dd[[1]]$fishstation$distance, na.rm=T)*1852)/1000, digits = 1)` km (`r round((sum(dd[[1]]$fishstation$distance, na.rm=T)), digits = 1)` nmi).  
  
The sampling stations were located in areas with bottom depths from `r round(min((stasamp$bottomdepthstart+stasamp$bottomdepthstop)/2), digits =1)` m to `r round(max((stasamp$bottomdepthstart+stasamp$bottomdepthstop)/2), digits = 1)` m, and the fishing depth varied from `r round(min((stasamp$fishingdepthmin+stasamp$fishingdepthmax)/2), digits=1)` m to `r round(max((stasamp$fishingdepthmin+stasamp$fishingdepthmax)/2), digits=1)` m.

## Mean bottom depth during trawl hauls
```{r bottom depth at stations, echo=FALSE, message=FALSE, fig.width=6, fig.height=2.5, out.width= "70%"}
## Depth at sampled stations - fish
stdat <- dd[[1]]$fishstation

stdat$gear.text <- "Bottom trawl"
stdat$gear.text[stdat$gear %in% c("3513", "3514", "3592")] <- "Pelagic trawl"

#Bottom depth
ggplot(stdat, aes((bottomdepthstart+bottomdepthstop)/2))+
  geom_histogram(color="black", position = "dodge")+
  labs(x= "Mean bottom depth during trawl haul (m)", y = "Number")+
  facet_wrap(~gear.text)+theme_bw()
```

## Mean fishing depth during trawl hauls
```{r fishing depth at stations, echo=FALSE, message=FALSE, fig.width=6, fig.height=3, out.width= "65%"}
#Fishing depth
ggplot(stdat, aes((fishingdepthmin+fishingdepthmax)/2, fill = gear.text))+
  geom_histogram(color="black")+
  labs(x= "Mean fishing depth during trawl haul (m)", y = "Number")+
  scale_fill_viridis_d(name = "Gear")+theme_bw()
```

\pagebreak

# Catch rates - biomass and number per nautical mile trawled for species registered in Sea2Data

## Species diversity

```{r summarise catches,echo=FALSE, message=FALSE}
#check what species are most common
tst<-stasamp %>% dplyr::group_by(scientificname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))
```

A total of `r length(unique(tst$scientificname))` species were registered in Sea2Data during the survey.

### Number of species identified versus the number of stations sampled

```{r cumulative numer of species, echo = FALSE, message=FALSE, fig.width=3, fig.height=3, out.width= "35%"}
#cumulative number of species vs number of stations

nspec <- data.frame(station=unique(stasamp$station),
           nspecies=tapply(cumsum(!duplicated(stasamp$scientificname)), stasamp$station,max))

nspec$nstation <- seq(1:nrow(nspec))

ggplot(nspec, aes(nstation, nspecies))+geom_line(size = 1)+theme_bw()+
  labs(x = "Number of stations sampled", y = "Number of unique species identified")
```

\pagebreak

## Average catch rate by species for the 20 species with highest catch rates

### Bottom trawl
```{r catch rates barplot,echo=FALSE, message=FALSE, fig.width=9, fig.height=3.3, out.width= "85%", fig.align="center", warning=FALSE}
tst<-stasamp %>% dplyr::group_by(gear.text,scientificname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))

gear <- "Bottom trawl"

#Weight
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(scientificname)),
       aes(reorder(scientificname, -meanW), meanW))+geom_col()+
  # geom_errorbar(aes(ymin = minW, ymax = maxW))+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$meanW[tst$gear.text==gear], na.rm=T)+20))+theme_bw()+
  theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11),
        axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Mean catch rate (kg/nmi)", title = "Biomass")

```

\pagebreak

### Bottom trawl excluding sponges
```{r catch rate barplots excl sponges, echo=FALSE, message=FALSE, fig.width=9, fig.height=3.3, out.width= "85%", fig.align="center", warning=FALSE}

#Weight
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(scientificname) & !scientificname == "Porifera"),
       aes(reorder(scientificname, -meanW), meanW))+geom_col()+
  # geom_errorbar(aes(ymin = minW, ymax = maxW))+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$meanW[tst$gear.text==gear & !tst$scientificname == "Porifera"], na.rm=T)+2))+theme_bw()+
  theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11),
        axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Mean catch rate (kg/nmi)", title = "Biomass")

#Number
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(scientificname) & !scientificname == "Porifera"),
       aes(reorder(scientificname, -meanN), meanN))+geom_col()+
  # geom_errorbar(aes(ymin = minN, ymax = maxN))+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$meanN[tst$gear.text==gear & !tst$scientificname == "Porifera"], na.rm=T)+100))+#, limits = c(0,700))+
  theme_bw()+theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11), axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Mean catch rate (N/nmi)", title = "Number of individuals")
```

## Spatial variation in catches of common species

```{r create space between plots, echo=FALSE, message=FALSE}
my_plot_hook <- function(x, options)
  paste("\n", knitr::hook_plot_tex(x, options), "\n")
knitr::knit_hooks$set(plot = my_plot_hook)
```

```{r spatial distribution of catches, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9, fig.height = 3, out.width="90%", fig.align="left"}
#Select which species you want to plot
species <- c("Gadus morhua", "Melanogrammus aeglefinus", "Mallotus villosus", "Boreogadus saida",
             "Micromesistius poutassou", "Clupea harengus", "Sebastes mentella", 
             "Hippoglossoides platessoides", "Pollachius virens")

#Get coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

#Set max size of bubbles in bubble plots
Bubble.size<-6       

#Select plot types (none, one or both)
numplot <- 0 #do you want to plot catches in numbers/nmi?
bioplot <- 1 #do you want to plot catches in kg/nmi?

for(i in 1:length(species)) {
  if (numplot == 1) {
    Title = paste("Catch rate (number of individuals)", "|", toString(format(Sys.Date(), "%Y")),
                  "|", toString(species[i]))
    g <- ggplot(bath, aes(x = x, y = y)) +
      geom_contour(
        aes(z = z),
        breaks = d.contours,
        colour = "lightblue",
        size = 0.5,
        show.legend = TRUE
      ) +
      geom_contour(aes(z = z),
                   breaks = c(0, 1),
                   color = "darkgrey",
                   size = .6) +
      geom_point(
        data = coord.track,
        aes(Lon.dd, Lat.dd, group = Date),
        alpha = 0.1,
        colour = "grey65",
        size = 0.1,
        inherit.aes = F
      ) +
      geom_point(
        data = stasamp %>% dplyr::filter(scientificname == species[i]),
        aes(longitudestart, latitudestart, size = cr.n.nm),
        shape = 21,
        alpha = 0.7,
        colour = "black",
        fill = "orange",
        stroke = .2
      ) +
      facet_grid( ~ gear.text) +
      scale_size_area(max_size = Bubble.size) +
      theme_bw() +
      coord_map(xlim = Xlim, ylim = Ylim) +
      labs(
        x = NULL,
        y = NULL,
        size = "Catch rate (N/nmi)",
        title = Title
      )
    print(g)
    
  }
  if (bioplot == 1) {
    Title = paste("Catch rate (biomass)", "|", toString(format(Sys.Date(), "%Y")),
                  "|", toString(species[i]))
    #Catch rate kg/nmi
    h <- ggplot(bath, aes(x = x, y = y)) +
      geom_contour(
        aes(z = z),
        breaks = d.contours,
        colour = "lightblue",
        size = 0.5,
        show.legend = TRUE
      ) +
      geom_contour(aes(z = z),
                   breaks = c(0, 1),
                   color = "darkgrey",
                   size = .6) +
      geom_point(
        data = coord.track,
        aes(Lon.dd, Lat.dd, group = Date),
        alpha = 0.1,
        colour = "grey65",
        size = 0.1,
        inherit.aes = F
      ) +
      geom_point(
        data = stasamp %>% dplyr::filter(scientificname == species[i]),
        aes(longitudestart, latitudestart, size = cr.kg.nm),
        shape = 21,
        alpha = 0.7,
        colour = "black",
        fill = "orange",
        stroke = .2
      ) +
      facet_grid( ~ gear.text) +
      scale_size_area(max_size = Bubble.size) +
      theme_bw() +
      coord_map(xlim = Xlim, ylim = Ylim) +
      labs(
        x = NULL,
        y = NULL,
        size = "Catch rate (kg/nmi)",
        title = Title
      )
    print(h)
  }
}
```

\pagebreak

## Length distributions

The following figures shows the length distribution of individuals sampled during the survey.

```{r length distributions large fish, echo=FALSE, message=FALSE, fig.width=8, fig.height=5.5, out.width= "80%", warning=FALSE}
stasampindi <- right_join(stasamp,dd[[1]]$individual)
stasampindiage <- left_join(stasampindi, dd[[1]]$agedetermination)

#Kg tinytex::tinytex_root()-> g and m -> cm
stasampindiage$weight.g <- (stasampindiage$individualweight * 1000 )
stasampindiage$length.cm <- (stasampindiage$length * 100 )

#Subset the data depending on measurement precision (largely demersal/pelagic species)
REF5cm <- subset(stasampindiage, commonname %in% c('torsk', "hyse", "sei", "snabeluer", "vanlig uer", "lusuer"))
REF1cm <- subset(stasampindiage, commonname %in% c('lodde', "polartorsk", "sild'G03", "kolmule"))

ggplot(data=REF5cm, aes(x=length.cm)) + geom_histogram(breaks=seq(0, 75, by=2), col="black", fill="steelblue", alpha = .6, stroke = 0.25)  + labs(title="Histogram of length", x="Length (cm)", y="Count") + facet_wrap(~scientificname, scales="free")+theme_bw()

```

```{r length distribution small fish, echo=FALSE, message=FALSE, fig.width=6, fig.height=5, out.width= "60%", warning=FALSE}
ggplot(data=REF1cm, aes(x=length.cm)) + geom_histogram(breaks=seq(0, 40, by=1), col="black", fill="steelblue", alpha = .6, stroke = 0.25)  + labs(title="Histogram of length", x="Length (cm)", y="Count") + facet_wrap(~scientificname, scales="free")+theme_bw()
```

## Length-weight relationships

```{r length-weight plots large fish, echo=FALSE, message=FALSE, fig.width=8, fig.height=5, out.width= "80%", warning=FALSE}
ggplot(REF5cm, aes(length.cm, individualweight))+geom_point(size = 0.5)+facet_wrap(~scientificname, scales = "free")+
  theme_bw()+labs(x = "Length (cm)", y = "Weight (kg)")
```

```{r length-weight plots small fish, echo=FALSE, message=FALSE, fig.width=5.5, fig.height=5, out.width= "50%", warning=FALSE}
ggplot(REF1cm, aes(length.cm, weight.g))+geom_point(size = 0.5)+facet_wrap(~scientificname, scales = "free")+
  theme_bw()+labs(x = "Length (cm)", y = "Weight (g)")

```
\pagebreak

## Length-age relationships

```{r length-age large fish, echo=FALSE, message=FALSE, fig.width=8, fig.height=5, out.width= "80%", warning=FALSE}
ggplot(REF5cm, aes(length.cm, age))+geom_point(size = 0.5)+facet_wrap(~scientificname, scales = "free")+
  theme_bw()+labs(x = "Length (cm)", y = "Age (years)")
```

```{r length-age small fish, echo=FALSE, message=FALSE, fig.width=5.5, fig.height=5, out.width= "50%", warning=FALSE}
ggplot(REF1cm, aes(length.cm, age))+geom_point(size = 0.5)+facet_wrap(~scientificname, scales = "free")+
  theme_bw()+labs(x = "Length (cm)", y = "Age (years)")
```
\pagebreak

## GSI versus maturity stage of female cod and haddock

```{r GSI cod and haddock, echo=FALSE, message=FALSE, fig.width=6, fig.height=3, out.width= "70%", warning=FALSE}
REF5cm$GSI <- (REF5cm$gonadweight/(REF5cm$individualweight-REF5cm$gonadweight))*100

ggplot(REF5cm %>% dplyr::filter(commonname %in% c("torsk", "hyse") & !is.na(maturationstage) & sex == "1"),
       aes(maturationstage, GSI))+geom_boxplot()+facet_wrap(~scientificname, scales = "free")+
  theme_bw()+labs(x = "Maturity stage", y = "GSI (%)")
```

\pagebreak

## GSI versus length and maturity stage for female haddock

The vertical line represents the size (40 cm) over which gonad samples should be taken if GSI < 2 % (horizontal line).

```{r GSI versus length and maturity haddock, echo=FALSE, message=FALSE, fig.width=9, fig.height=6, out.width= "80%", warning=FALSE}

ggplot(REF5cm %>% dplyr::filter(commonname == "hyse" & !is.na(maturationstage) & sex == "1"),
       aes(length.cm, GSI))+geom_point(aes(color = maturationstage), shape = 3, size = 1, stroke = 1)+facet_wrap(~scientificname, scales = "free")+geom_abline(slope = 0, intercept = 2)+
  geom_vline(xintercept = 40)+
  theme_bw()+labs(x = "Length (cm)", y = "GSI (%)")
```
\pagebreak

## GSI versus length and maturity stage for female cod

The vertical line represents the size (60 cm) over which most females with GSI > 1.5 % (horizontal line) are maturing (Skjæraasen et al. 2012).

```{r GSI versus length and maturity cod, echo=FALSE, message=FALSE, fig.width=9, fig.height=6, out.width= "80%", warning=FALSE}

ggplot(REF5cm %>% dplyr::filter(commonname == "torsk" & !is.na(maturationstage) & sex == "1"),
       aes(length.cm, GSI))+geom_point(aes(color = maturationstage), shape = 3, size = 1, stroke = 1)+facet_wrap(~scientificname, scales = "free")+geom_abline(slope = 0, intercept = 1.5)+
  geom_vline(xintercept = 60)+
  theme_bw()+labs(x = "Length (cm)", y = "GSI (%)")
```

\pagebreak

# Acoustic registrations

```{r read in acoustic data 1, echo=FALSE, message=FALSE, warning=FALSE}
### Get acoustic data

#Read in depth-integrated acoustic data from the Acoustic/Integrated directory
dat <- paste0("Data/Acoustic/Integrated/",list.files(path="Data/Acoustic/Integrated", pattern = ".txt"))

acu.dat<-read.csv(dat, header=T)

#Prepare file
acu.year<-as.numeric(substr(acu.dat$DATE,1,5))
acu.dat<- dplyr::select(acu.dat,SHIP,NATION,SURVEY,FREQUENCY,TR,DATE,TIME,LOGSTART,LOGSTOP,LONGITUDE,LATITUDE,DEPTH, c(13:ncol(acu.dat)))
acu.dat<-cbind(acu.dat,acu.year)
acu.dat<-plyr::rename(acu.dat,replace = c("acu.year"="YEAR"))

```

A total of `r (round((sum(acu.dat$LOGSTOP[acu.dat$LOGSTOP>5000]-acu.dat$LOGSTART[acu.dat$LOGSTOP>5000]) + sum(acu.dat$LOGSTOP[acu.dat$LOGSTOP<=5000]-acu.dat$LOGSTART[acu.dat$LOGSTOP<=5000])), digits = 1)*1852)/1000` km (`r round(sum(acu.dat$LOGSTOP[acu.dat$LOGSTOP>5000]-acu.dat$LOGSTART[acu.dat$LOGSTOP>5000]) + sum(acu.dat$LOGSTOP[acu.dat$LOGSTOP<=5000]-acu.dat$LOGSTART[acu.dat$LOGSTOP<=5000]), digits = 1)` nmi ) of acoustic transects were scrutinized.

## Example echograms

<!-- ![](LSSS caption 1 capelin.png){width=8in} -->

<!-- Screenshot from Johan Hjort showing a confirmed capelin school with unusal frequency response, likely caused by emptying of the swim bladder. 06.09.2019, Barents Sea ecosystem survey. Position approximately 76 32 N, 01741 E. LSSS v. 2.6.0. -->

## Depth-integrated acoustic backscatter

### Total backscatter

```{r prepare and plot total SA, echo=FALSE, message=FALSE, fig.width=6, fig.height=4, out.width= "60%", warning=FALSE}
### Map area etc
Bubble.size<-9        #Max size of bubbles in bubble plots

### Selection variables
Year <- format(Sys.time(), "%Y")
Frequency<-c(38000)         #c(3800,120000) c(120000)  - NULL=all frequencies

#Select all species, and the total, and the 38 kHz frequency (in case there are other frequencies in the file)
acu.dat.spec<- select(acu.dat,YEAR,FREQUENCY,LONGITUDE,LATITUDE, c(13:ncol(acu.dat)))
if(is.null(Year)==FALSE)
  acu.dat.map<-acu.dat.spec %>% filter(YEAR%in%Year)
if(is.null(Frequency)==FALSE)
  acu.dat.map<-acu.dat.map %>% filter(FREQUENCY %in% Frequency)

#Melt data so we can plot all acoustic categories in one figure with ggplot
acu.dat.map.melt <- reshape2::melt(acu.dat.map, id.vars = c(1:4))

#Change the names of acoustic categories
labls <- c("Other","Plankton", "Capelin", "Haddock","Cod", "Total") #herring? NB check order in output!!

acu.dat.map.melt$variable <- factor(acu.dat.map.melt$variable,
                                    levels = c(paste(names(acu.dat.map)[5:ncol(acu.dat.map)])),
                                    labels = labls)

# Plot title
Yr <- sort(unique(acu.dat.map$YEAR))
Fr <- sort(unique(acu.dat.map$FREQUENCY))/1000
Title=paste("Winter survey Johan Hjort","|",toString(Yr),"|",toString(Fr),"kHz")

#Plot total acoustic backscatter
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + #for coastline only as line, activate this and skip geom_polygon
  geom_point(data=acu.dat.map.melt %>% dplyr::filter(variable == "Total"),
             aes(LONGITUDE,LATITUDE,size = value),shape=21, alpha = 0.3, colour = "black",fill="orange",stroke = .2)+
  facet_wrap(~variable)+
  geom_path(data=acu.dat.map.melt  %>% dplyr::filter(variable == "Total"),aes(LONGITUDE,LATITUDE), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Sa - values", title=Title)
```

\pagebreak

### Pelagic species

```{r plot SA of pelagics, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, out.width= "90%", warning=FALSE, fig.align="center"}
# Plot
pelagics <- c("Plankton","Capelin") #+herring?

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + #for coastline only as line, activate this and skip geom_polygon
  geom_point(data=acu.dat.map.melt %>% dplyr::filter(variable %in% pelagics),
             aes(LONGITUDE,LATITUDE,size = value),shape=21, alpha = 0.3, colour = "black",fill="orange",stroke = .2)+
  facet_wrap(~variable)+
  geom_path(data=acu.dat.map.melt  %>% dplyr::filter(variable %in% pelagics),
            aes(LONGITUDE,LATITUDE), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Sa - values", title=Title)
```

### Demersal species

```{r plot SA of demersals, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, out.width= "90%", warning=FALSE, fig.align="center"}

demersals <- c("Cod", "Haddock")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + #for coastline only as line, activate this and skip geom_polygon
  geom_point(data=acu.dat.map.melt %>% dplyr::filter(variable %in% demersals),
             aes(LONGITUDE,LATITUDE,size = value),shape=21, alpha = 0.3, colour = "black",fill="orange",stroke = .2)+
  facet_wrap(~variable)+
  geom_path(data=acu.dat.map.melt %>% dplyr::filter(variable %in% demersals),
            aes(LONGITUDE,LATITUDE), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Sa - values", title=Title)

```

## Acoustic backscatter in depth channels

### Distance from the surface to weighted depth of acoustic registrations
```{r read in acoustic data 2 and plot vertical distribution of pelagics, echo=FALSE, eval=T, message=FALSE, fig.width=8, fig.height=4, out.width= "90%", warning=FALSE, fig.align="center"}

#### SA resolved in depth channels, plot day night distribution of SA for each species
#in a histogram

#Read in depth-integrated acoustic data from the Acoustic/Integrated directory
dat <- paste0("Data/Acoustic/Channels/",list.files(path="Data/Acoustic/Channels", pattern = ".txt"))

acu.ch<-read.table(dat, header=T)

## calculate solar elevation angle for each point

#split time variable into hour, min, sec
times <- colsplit(acu.ch$UTC, pattern = c(":"), names = c("hour", "min", "sec"))
acu.ch.sun <- cbind(acu.ch, times)
acu.ch.sun$hour <- as.numeric(acu.ch.sun$hour)
acu.ch.sun$min <- as.numeric(acu.ch.sun$min)
acu.ch.sun$sec <- as.numeric(acu.ch.sun$min)

#function for calculating solar elevation angle from geographical position and time of day
alt.of.sun <- function(min=x$min, hour=x$hour, day=x$DA, month=x$MO,
                       lat=x$LATITUDE, lon=x$LONGITUD){
  # altitude of sun
  UTC <- hour + min/60
  CET <- (UTC + 1) %% 24
  dayadd <- cumsum(c(0,31,28,31,30,31,30,31,31,30,31,30,31))
  cumday <- day + dayadd[month]
  K1 <- (lon - 15 - 0.4083 * sin(0.0172 * (cumday-80))
         - 1.7958 * cos(0.0172 * (cumday-80))
         + 2.4875 * sin(0.0344 * (cumday-80)))
  SST <- ((CET*15) + K1) / (180/pi)
  dkl <- asin(0.3979 * sin((0.0172 * (cumday - 80))
                           + 0.03346 * (sin(0.0172 * cumday) - 0.98112)))
  Brq <- lat/(180/pi)
  sinush <- (sin(dkl)*sin(Brq)) - (cos(dkl)*cos(Brq)*cos(SST))
  alt.of.sun <- asin(sinush) * (180/pi)

  # time when altitude of sun = asun.0
  asun.0 <- 0
  K2 <- (sin(dkl)*sin(Brq) - sin(asun.0/(180/pi))) / (cos(dkl)*cos(Brq))
  K2[K2 < (-1)] <- -1        # polar night
  K2[K2 > ( 1)] <-  1         # midnight sun
  SST0 <- acos(K2)
  CET0 <- (SST0 * (180/pi) - K1) / 15
  UTC0 <- (CET0 - 1) + 24*(CET0 < 1)
  sun.rise <- UTC0%%24
  sun <- data.frame(month, day, hour, min, lon, lat,
                    alt.of.sun, sun.rise)
  return(sun)
}

#do the calculation
x <- acu.ch.sun
sun <- alt.of.sun()
acu.ch.sun <- cbind(acu.ch.sun, sunheight = sun$alt.of.sun, sunrise = sun$sun.rise)

#define day/night observations
acu.ch.sun$TOD <- "Night"
acu.ch.sun$TOD[acu.ch.sun$sunheight-acu.ch.sun$sunrise>0] <- "Day"

#reshape data to long format for plotting
acu.ch.melt <- melt(acu.ch.sun, id.vars = c(1:16,(ncol(acu.ch)+1):ncol(acu.ch.sun)))

#calculate mean depths weighted by SA for each position and category
acu.wmean <- acu.ch.melt %>% dplyr::group_by(LONGITUD, LATITUDE,TOD,BDMIN, BDMAX,
                                      corr.sun = sunheight-sunrise,variable) %>%
  dplyr::summarise(wdepth = weighted.mean(PDMEAN, w = value)) %>% data.frame()

#change category names
acu.wmean$variable <- factor(acu.wmean$variable,
                                    levels = c(paste(names(acu.ch)[17:ncol(acu.ch)])),
                                    labels = labls)

#Here is code for two different plots;
#1) the depth of acoustic registrations - most relevant for species with diel vertical migration, where the light level is proportional to the depth they occupy
#2) the distance of acoustic registrations to the seafloor, or in cases when the bottom depth is > 600 m, the distance to the maximum scrutinized depth - may be relevant for looking at the depth distribution of demersal species

#Plot histogram of weighted depth of acoustic regitrations by time of day and acoustic category

#pelagic species
ggplot(acu.wmean %>% dplyr::filter(variable %in% pelagics),
       aes(wdepth))+geom_histogram(aes(fill=TOD), position="dodge", binwidth = 20)+
  facet_wrap(~variable)+ coord_flip()+scale_x_continuous(limits=c(0,max(acu.wmean$wdepth, na.rm=T)+20))+
  scale_x_reverse()+
  scale_fill_viridis_d(name="Time of day", direction = -1)+theme_bw()+
  labs(y = "Number of observations (scrutinized nmi)",
       x = "Weighted depth of acoustic backscatter (m)", title = "Pelagic species")
```

\pagebreak

### Distance from the seafloor (or max scrutinized depth) to weighted depth of acoustic registrations

```{r plot vertical distribution of demersals, echo=FALSE,eval=T, message=FALSE, fig.width=8, fig.height=4, out.width= "90%", warning=FALSE, fig.align="center"}
ggplot(acu.wmean %>% dplyr::filter(variable %in% demersals),
       aes(BDMAX-wdepth))+
  geom_histogram(aes(fill=TOD), position="dodge", binwidth = 20)+
  facet_wrap(~variable) + coord_flip() +
  scale_x_continuous(limits=c(0,max(acu.wmean$BDMAX-acu.wmean$wdepth, na.rm=T)+20)) +
  scale_fill_viridis_d(name="Time of day", direction = -1) + theme_bw()+
  labs(y = "Number of observations (scrutinized nmi)",
       x = "Distance to max scutinized depth (m)", title = "Demersal species")
```

\pagebreak

# CTD
```{r read in ctd data, echo=FALSE, message=FALSE}

#create a list of the files from your target directory
file_list <- list.files(path="Data/CTD",  pattern = ".cnv")

#set temporary working directory
setwd("Data/CTD")

#initiate a blank data frame, each iteration of the loop will append the data from the given file to this variable
ctd <- data.frame()

for (i in 1:length(file_list)){
  temp_data <- fread(file_list[i], stringsAsFactors = F,header = F, skip = 320) #read in files using the fread function from the data.table package
  names(temp_data) <- c("scan_count", "pressure_db", "temperature", "temperature_2", 
                   "conductivity", "conductivity_2", "oxygen_raw", "altimeter", 
                   "par_irradiance", "surface_irradiance", "corrected_irradiance", 
                   "oxygen_ml_l", "salinity_PSU", "density", "sound_velocity", 
                   "sound_velocity_av", "flag")
  #select the measurements from when the CTD was descending
  temp_data <- temp_data[1:ceiling(nrow(temp_data)/2),]
  #Create a station variable from the file name
  temp_data$station <- strsplit(gsub(".cnv", "", file_list[i]), "sort")[[1]][2] 
  ctd <- rbindlist(list(ctd, temp_data), use.names = T) #for each iteration, bind the new data to the building dataset
  rm(temp_data)
}

##position of stations is in data.frame called dataset from the cruise log

ctdpos <- dataset %>% dplyr::select(gear.text,Loc.St.No,Time,Date, Lon.dd, Lat.dd) %>% 
  dplyr::rename(station = Loc.St.No) %>% dplyr::filter(!is.na(station) & gear.text == "CTD") %>% 
  dplyr::arrange(station) %>% data.frame()
ctdpos$station <- as.character(ctdpos$station) 
ctdpos <- ctdpos %>% dplyr::group_by(station) %>% 
  dplyr::summarise(Lon = mean(Lon.dd),Lat = mean(Lat.dd), Time = unique(Time)[1], 
                   Date = unique(Date)[1])
for(i in 1:length(ctdpos$station)){
 while(nchar(ctdpos$station[i])<4){
  ctdpos$station[i] <- paste0("0",ctdpos$station[i])
 }
}

ctd <- left_join(ctd, ctdpos)

maxdepth <- ctd %>% dplyr::group_by(station, Lon, Lat) %>% 
  dplyr::summarise(max_depth = max(pressure_db))
ctd <- left_join(ctd, maxdepth)
ctd$plotdepth <- NA
ctd$plotdepth[ctd$pressure_db<=50] <- "Surface"
ctd$plotdepth[ctd$max_depth-ctd$pressure_db<=50] <- "Bottom"

#If the depth is <= 50 m, the surface layer will be overwritten by the bottom layer in the command above. Therefore add an extra line with the same temperature for surface.
for(i in 1:nrow(ctd)){
  if(ctd$max_depth[i]<=51){
    extra <- ctd[i,]
    extra$plotdepth <- "Surface"
    ctd <- rbind(ctd, extra)
  }}

ctd.plot <- ctd %>% dplyr::group_by(station, Lon, Lat, Date, Time, plotdepth, max_depth) %>% 
  dplyr::summarise(mean_temp = mean(temperature), mean_salinity = mean(salinity_PSU)) %>% dplyr::filter(!is.na(plotdepth)) %>% 
  data.frame()

```

## Summary of measurements

`r length(unique(ctd$station))` CTD casts were done during the survey, covering a total depth of `r round(sum(maxdepth$max_depth)/1000, digits = 1)` km.

```{r plot all CTD measurements, echo=FALSE, fig.height=3, fig.width=4.5, out.width= "40%",fig.show="hold", message=FALSE, warning=FALSE}

ggplot(ctd, aes(temperature))+geom_histogram(color="black")+theme_bw()+
  labs(x = "Temperature (deg C)", y = "Count")

ggplot(ctd, aes(salinity_PSU))+geom_histogram(color="black")+theme_bw()+
  labs(x = "Salinity (PSU)", y = "Count")
```

\pagebreak

## Variation in temperature and salinity with bathymetry and geographical location

```{r spatial variation in temperature, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, out.width= "85%", warning=FALSE, fig.align="center"}

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) +
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey45", size=0.1, inherit.aes = F)+
  geom_point(data=ctd.plot, aes(Lon, Lat, fill = mean_temp), size = 2, color="black", shape = 21)+
  facet_wrap(~plotdepth)+
  scale_fill_distiller(palette="RdYlBu")+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", fill="Mean temperature
(deg C)")
```

```{r spatial variation in salinity, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, out.width= "85%", warning=FALSE, fig.align="center"}

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) +
 geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey45", size=0.1, inherit.aes = F)+
  geom_point(data=ctd.plot, aes(Lon, Lat, fill = mean_salinity), size = 2, color="black", shape = 21)+
  facet_wrap(~plotdepth)+
  scale_fill_distiller(palette="BuPu", trans = "reverse", guide = guide_colorbar(reverse = T))+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", fill="Mean salinity (PSU)")
```

\pagebreak
## Density in the water column

```{r density in water column, echo=FALSE, message=FALSE, fig.width=9, fig.height=2.8, warning=FALSE, fig.align="center"}

depthlim <- 100 #choose the maximum depth you want to plot

ggplot(ctd, aes(density, pressure_db, group=station, color=Lat))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("Density (sigma-t, kg/"*m^3*")"), 
       y = "Depth (m)", color="Latitude (N)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
                   panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
                   panel.grid.minor = element_blank())

ggplot(ctd, aes(density, pressure_db, group=station, color=Lon))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("Density (sigma-t, kg/"*m^3*")"), 
       y = "Depth (m)", color="Longitude (E)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
                   panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
                   panel.grid.minor = element_blank())
```

\pagebreak
## Light in the water column

```{r light in water column, echo=FALSE, message=FALSE, fig.width=9, fig.height=4, warning=FALSE, fig.align="center"}

tst <- strptime(ctd$Time, format = "%H:%M:%S")
tt1 <- chron::times(format(tst, "%H:%M:%S"))
ctd$timetest <- tt1

ctd$newtime <- hours(ctd$timetest)

ggplot(ctd, aes(par_irradiance, pressure_db, group=station, color=newtime))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("PAR irradiance ("*mu*"E/"*m^2*"s"*")"), 
       y = "Depth (m)", color="Time of day (h)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
        panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
        panel.grid.minor = element_blank())

```
