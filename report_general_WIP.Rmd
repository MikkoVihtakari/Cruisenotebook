---
title: |
  ![](HI logo farger engelsk){width=1in}  
  Ecosystem survey 2019 R/V Johan Hjort
author: 'Report generated by: Johanna Fall'
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  pdf_document:
    extra_dependencies: flafter
    toc: yes
    toc_depth: 3
    number_sections: true
classoption: landscape
---
\fontsize{12}{18}
\selectfont

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 220, dev = "CairoPNG")
```

```{r install and load packages, echo=FALSE, message=FALSE}
#Load required packages
Packages <- c("data.table", "reshape2", "readxl", "readODS", "worms","Cairo",
              "bookdown", "RstoxData", "maps", "mapdata", "chron","tidyverse")

invisible(lapply(Packages, FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
))

```

```{r customise report to cruise, echo=FALSE, message=FALSE}

# Directory check - controls which parts of the script that will be run
ACO <- dir.exists("ACOUSTIC/LSSS/REPORTS")
BIO <- dir.exists("CATCH_MEASUREMENTS/BIOTIC")
CTD <- dir.exists("PHYSICS/CTD/CTD_DATA")
TRA <- dir.exists("CRUISE_LOG/TRACK")

# Define map extent and depth contours
Ylim<-c(70,78.5) # Latitude range
Xlim<-c(8, 38)   # Longitude range
d.contours<-c(-100, -300,-500) #Depth contours for plots with bathymetry

# Define the countries to show in the maps
europe <- map_data("worldHires", c("Norway", "Sweden", "Russia", "Finland")) 

# Select species for distribution maps
species <- c("Mallotus villosus", "Boreogadus saida","Micromesistius poutassou", "Clupea harengus", "Melanogrammus aeglefinus", "Gadus morhua", "Sebastes mentella", "Sebastes norvegicus", "Sebastes viviparus", "Pandalus borealis")

# Set max size of bubbles in species distribution plots
Bubble.size<-6       

# Select metric for catches in species distribution plots (none, one or both)
numplot <- 0 #do you want to plot catches in numbers/nmi?
bioplot <- 1 #do you want to plot catches in kg/nmi?

```

\pagebreak

# Survey description and data availability

\pagebreak

# Cruise tracks and stations

Cruise tracks from the position log with points indicating start positions for different sampling gear. The points are jittered slightly for better visual representation:

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=6, out.width= "75%", fig.align="center"}
if(TRA == TRUE){
 # Get bathymetry data from file
bath1<-read_csv(file = "Data/GeoData/ETOPO1_nm4.csv")

#reduce the resolution of depth contours (to increase speed when writing to file)
bath<-subset(bath1, bath1$y>(Ylim[1]-2) & (bath1$y<Ylim[2]+2) & bath1$ x>(Xlim[1]-2)& bath1$x<(Xlim[2]+2) & bath1$z<=(d.contours[1]+1500) & bath1$z>=(d.contours[length(d.contours)]-1500))

#create a list of the position files from the target directory
file_list <- list.files(path="Data/Track", pattern = ".csv")

#initiate a blank data frame, each iteration of the loop will append the data from the given file to this variable
dataset <- data.frame()

#set temporary working directory
setwd("Data/Track")

for (i in 1:length(file_list)){
  temp_data <- fread(file_list[i], stringsAsFactors = F,header = T, skip = 2,fill = T,strip.white = FALSE) #read in files using the fread function from the data.table package
  #creating a new column that indicates which date each file comes from
  temp_data$Date <- strsplit(gsub(".csv", "", file_list[i]), "s")[[1]][2]
  temp_data$Date <- as.Date(temp_data$Date, format = "%d-%m-%Y")
  #The latitude column is in format "DDMM.MMMM N"
  #The longitude column is in format "0DDMM.MMMM E"
  #Create new columns with lon and lat in decimal degrees
  temp_data <- temp_data %>% separate(Latitude, into = c("DD", "MM", "x1"), 
                                      sep = c(2,9), remove = F) %>% 
    separate(Longitude, into = c("x1.lon", "DD.lon", "MM.lon", "x2.lon"), 
             sep = c(1,3,10), remove = F)
  temp_data$DD <- as.numeric(temp_data$DD)
  temp_data$DD.lon <- as.numeric(temp_data$DD.lon)
  temp_data$MM <- as.numeric(temp_data$MM)
  temp_data$MM.lon <- as.numeric(temp_data$MM.lon)
  temp_data$Lat.dd <- temp_data$DD + temp_data$MM/60
  temp_data$Lon.dd <- temp_data$DD.lon + temp_data$MM.lon/60
  
  temp_data <-  temp_data %>% dplyr::rename(gear.text = `Station type`)
  
  #for each iteration, bind the new data to the building dataset
  dataset <- rbindlist(list(dataset, temp_data), use.names = T, fill = T) 
  #arrange after date
  dataset  <- dataset %>% arrange(Date)
  rm(temp_data)
  }

#Plot the cruise tracks and stations
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_map(data=europe, map=europe,  aes(x=long, y=lat, map_id=region),
           color="gray50", fill="gray60")+
  geom_point(data=dataset, aes(Lon.dd, Lat.dd, group = Date), alpha=0.25, colour="grey45", size=0.05, inherit.aes = F)+
  geom_jitter(data = dataset %>% dplyr::filter(!gear.text == "  -->" &
                                                !grepl("stop",gear.text)), 
             aes(Lon.dd, Lat.dd, shape=gear.text), size = 2, 
             inherit.aes = F, width = 0.1)+
  scale_color_viridis_d(na.translate=F)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", color="Sampling gear")
}

```
\pagebreak
```{r read in biotic data, echo = FALSE, message=FALSE, warning = FALSE, results='hide', eval=BIO}
#specify file path
tokt <- paste0("CATCH_MEASUREMENTS/BIOTIC/",
               list.files(path="CATCH_MEASUREMENTS/BIOTIC", pattern = ".xml"))

#read in with function ReadBiotic from RstoxData
dd<- ReadBiotic(tokt)

#Combine station and catch data
stasamp <- right_join(dd[[1]]$fishstation,dd[[1]]$catchsample) %>% mutate(cr.kg.nm=catchweight/distance) %>% mutate(cr.n.nm=catchcount/distance)

# Add scientific species names (code from Ibrahim Umar)

# Source Edvin Fugleback's script for translating species names from aphia codes
source("https://github.com/Sea2Data/cruisetools/raw/master/taxaAnnotation/annotateTaxa.R")

# Get taxa taxaTable
## Get list of aphias
aphias <- unlist(unique(stasamp$aphia[!is.na(stasamp$aphia)])) 
## Make taxa table 
taxaTable <- makeTaxaTable(aphias)

# Merge with NMD biotic data - removing scientificname column in stasamp data (NA values)
stasamp <- left_join(stasamp[,-"scientificname"], 
                     taxaTable %>% select(AphiaID,scientificname),
                     by=c("aphia"="AphiaID"))

#Legg til geartype i tekstformat
stasamp$gear.text <- NA
stasamp$gear.text[grepl("^30",stasamp$gear)] <- "Bottom trawl"
stasamp$gear.text[grepl("^31",stasamp$gear)] <- "Bottom trawl"
stasamp$gear.text[grepl("^32",stasamp$gear)] <- "Bottom trawl"
stasamp$gear.text[grepl("^34",stasamp$gear)] <- "Unspecified trawl"
stasamp$gear.text[grepl("^35",stasamp$gear)] <- "Pelagic trawl"
stasamp$gear.text[grepl("^36",stasamp$gear)] <- "Danish seine"
stasamp$gear.text[grepl("^37",stasamp$gear)] <- "Seine"
stasamp$gear.text[grepl("^40",stasamp$gear)] <- "Gill net"
stasamp$gear.text[grepl("^41",stasamp$gear)] <- "Gill net"

# Station data
stdat <- stasamp %>% select(serialnumber, station, stationstarttime, longitudestart,
                            latitudestart, bottomdepthstart, bottomdepthstop,
                            fishingdepthmin, fishingdepthmax, gear.text, samplequality) %>% unique()
```

```{r sample statistics, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("## Sampling effort\n")

cat("Total number of hauls taken during the survey:")
```
`r if(BIO==TRUE) nrow(stdat)`

```{r sample statistics2, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("Number of samples by gear type:")
```
`r if(BIO==TRUE) table(stdat$gear.text)`

```{r sample statistics3, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("Range of bottom depths at sampling stations (m):")
```
`r if(BIO==TRUE) round(range((stasamp$bottomdepthstart+stasamp$bottomdepthstop)/2), digits =1)`

```{r trawl statistics4, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("Fishing depth range (m):")
```
`r if(BIO==TRUE) round(range((stasamp$fishingdepthmin+stasamp$fishingdepthmax)/2), digits=1)`

```{r fig bottom depth, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("### Mean bottom depth during hauls  ")
```

```{r, echo=FALSE, message=FALSE, fig.width=6, fig.height=2.5, out.width= "70%", eval = BIO}
#Bottom depth
ggplot(stdat, aes((bottomdepthstart+bottomdepthstop)/2))+
  geom_histogram(color="black", position = "dodge")+
  labs(x= "Mean bottom depth during haul (m)", y = "Number")+
  facet_wrap(~gear.text)+theme_bw()+
  scale_y_continuous(breaks = c(0,2,4,6,8,10,12))
```

```{r, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("### Mean fishing depth during hauls\n")
```

```{r, echo=FALSE, message=FALSE, fig.width=6, fig.height=3, out.width= "65%", eval=BIO}
#Fishing depth
ggplot(stdat, aes((fishingdepthmin+fishingdepthmax)/2, fill = gear.text))+
  geom_histogram(color="black")+
  labs(x= "Mean fishing depth during haul (m)", y = "Number")+
  scale_fill_viridis_d(name = "Gear")+theme_bw()
```

```{r, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("# Catch composition\n")
cat("## Species diversity\n")
```

```{r,echo=FALSE, message=FALSE, eval=BIO}
#Sjekk hvilke arter som er vanligst
options(dplyr.summarise.inform=F)
tst<-stasamp %>% dplyr::group_by(scientificname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))
```

```{r, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("Number of species registered during the survey:")
```
`r if(BIO==TRUE) length(unique(tst$scientificname))`

```{r, echo = FALSE, message=FALSE, fig.width=7, fig.height=3.5, out.width= "70%", eval = BIO}
#cumulative number of species vs number of stations
nspec <- data.frame(station=unique(stasamp$station),
           nspecies=tapply(cumsum(!duplicated(stasamp$scientificname)), stasamp$station,max))

nspec$nstation <- seq(1:nrow(nspec))

ggplot(nspec, aes(nstation, nspecies))+geom_line(size = 1)+theme_bw()+
  labs(x = "Number of stations sampled", y = "Number of unique species identified",
       title = "Number of species identified versus number of stations sampled")
```

```{r, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("## Max catch rate by species for the 20 species with highest catch rates\n")
```

```{r,echo=FALSE, message=FALSE, fig.width=9, fig.height=3.3, out.width= "85%", fig.align="center", warning=FALSE, eval= BIO}
options(dplyr.summarise.inform=F)
tst<-subset(stasamp, gearcondition==1) %>% 
  dplyr::group_by(gear.text,scientificname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))
tst2 <- tst %>% group_by(gear.text) %>% summarise(highN = max(maxN, na.rm = T),
                                                  highW = max(maxW, na.rm = T))
tst <- left_join(tst, tst2)
tst$ismaxN <- FALSE
tst$ismaxN[tst$maxN==tst$highN] <- TRUE
tst$ismaxW <- FALSE
tst$ismaxW[tst$maxW==tst$highW] <- TRUE
```

```{r, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("Species with highest catch rate by gear - biomass:")
```

`r if(BIO==TRUE) table(tst$scientificname[tst$ismaxW==TRUE], by = tst$gear.text[tst$ismaxW==TRUE])`

```{r, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("Species with highest catch rate by gear - numbers:")
```

`r if(BIO==TRUE) table(tst$scientificname[tst$ismaxN==TRUE], by = tst$gear.text[tst$ismaxN==TRUE])`

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, out.width= "85%", fig.align="center", warning=FALSE, eval=BIO}

gear <- "Bottom trawl"

#Weight
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(scientificname)),
       aes(reorder(scientificname, -maxW), maxW))+geom_col()+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$maxW[tst$gear.text==gear], na.rm=T)+2))+theme_bw()+
  theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11),
        axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Max catch rate (kg/nmi)", title = "Biomass")

#Number
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(scientificname)),
       aes(reorder(scientificname, -maxN), maxN))+geom_col()+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$maxN[tst$gear.text==gear], na.rm=T)+15))+#, limits = c(0,700))+
  theme_bw()+theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11), axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Max catch rate (N/nmi)", title = "Number of individuals")
```
```{r, eval = BIO, echo = FALSE, message = FALSE, results = 'asis'}
cat("### Pelagic trawl\n")
```

### Pelagic trawl

The species with highest catch rates in pelagic trawls were `r g<-tst %>% filter(gear.text == "Pelagic trawl") %>% arrange(-maxW);g[1,2]` (`r unique(stasamp$commonname[stasamp$scientificname %in% toString(g[1,2])])`) by biomass, and `r g<-tst %>% filter(gear.text == "Pelagic trawl") %>% arrange(-maxN);g[1,2]` (`r unique(stasamp$commonname[stasamp$scientificname %in% toString(g[1,2])])`) by number.

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3.3, out.width= "85%", fig.align="center", warning=FALSE}
gear <- "Pelagic trawl"
#Weight
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(scientificname)),
       aes(reorder(scientificname, -maxW), maxW))+geom_col()+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$maxW[tst$gear.text==gear], na.rm=T)+2))+theme_bw()+
  theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11),
        axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Max catch rate (kg/nmi)", title = "Biomass")
#Number
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(scientificname)),
       aes(reorder(scientificname, -maxN), maxN))+geom_col()+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$maxN[tst$gear.text==gear], na.rm=T)+15))+#, limits = c(0,700))+
  theme_bw()+theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11), axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Max catch rate (N/nmi)", title = "Number of individuals")
```

## Spatial variation in catches of common species

```{r create space between plots, echo=FALSE, message=FALSE}
my_plot_hook <- function(x, options)
  paste("\n", knitr::hook_plot_tex(x, options), "\n")
knitr::knit_hooks$set(plot = my_plot_hook)
```

```{r spatial distribution of catches, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 9, fig.height = 3, out.width="90%", fig.align="left"}
#Get coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()
for(i in 1:length(species)) {
  if (numplot == 1) {
    Title = paste("Catch rate (number of individuals)", "|", toString(format(Sys.Date(), "%Y")),
                  "|", toString(species[i]))
    g <- ggplot(bath, aes(x = x, y = y)) +
      geom_contour(
        aes(z = z),
        breaks = d.contours,
        colour = "lightblue",
        size = 0.5,
        show.legend = TRUE
      ) +
      geom_map(data=europe, map=europe,  aes(x=long, y=lat, map_id=region),
           color="gray50", fill="gray60")+
      geom_point(
        data = coord.track,
        aes(Lon.dd, Lat.dd, group = Date),
        alpha = 0.1,
        colour = "grey65",
        size = 0.1,
        inherit.aes = F
      ) +
      geom_point(
        data = stasamp %>% dplyr::filter(scientificname == species[i]),
        aes(longitudestart, latitudestart, size = cr.n.nm),
        shape = 21,
        alpha = 0.7,
        colour = "black",
        fill = "orange",
        stroke = .2
      ) +
      facet_grid( ~ gear.text) +
      scale_size_area(max_size = Bubble.size) +
      theme_bw() +
      coord_map(xlim = Xlim, ylim = Ylim) +
      labs(
        x = NULL,
        y = NULL,
        size = "Catch rate (N/nmi)",
        title = Title
      )
    print(g)
    
  }
  if (bioplot == 1) {
    Title = paste("Catch rate (biomass)", "|", toString(format(Sys.Date(), "%Y")),
                  "|", toString(species[i]))
    #Catch rate kg/nmi
    h <- ggplot(bath, aes(x = x, y = y)) +
      geom_contour(
        aes(z = z),
        breaks = d.contours,
        colour = "lightblue",
        size = 0.5,
        show.legend = TRUE
      ) +
      geom_map(data=europe, map=europe,  aes(x=long, y=lat, map_id=region),
           color="gray50", fill="gray60")+
      geom_point(
        data = coord.track,
        aes(Lon.dd, Lat.dd, group = Date),
        alpha = 0.1,
        colour = "grey65",
        size = 0.1,
        inherit.aes = F
      ) +
      geom_point(
        data = stasamp %>% dplyr::filter(scientificname == species[i]),
        aes(longitudestart, latitudestart, size = cr.kg.nm),
        shape = 21,
        alpha = 0.7,
        colour = "black",
        fill = "orange",
        stroke = .2
      ) +
      facet_grid( ~ gear.text) +
      scale_size_area(max_size = Bubble.size) +
      theme_bw() +
      coord_map(xlim = Xlim, ylim = Ylim) +
      labs(
        x = NULL,
        y = NULL,
        size = "Catch rate (kg/nmi)",
        title = Title
      )
    print(h)
  }
}
```
\pagebreak

## Length-weight relationships - all species

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=6, out.width= "90%", warning=FALSE}
stasampindi <- right_join(stasamp,dd[[1]]$individual)
stasampindiage <- left_join(stasampindi, dd[[1]]$agedetermination)
#m -> cm
stasampindiage$length.cm <- (stasampindiage$length * 100 )
#create list of unique species
species <- stasampindiage %>% dplyr::filter(individualweight > 0 & !is.na(scientificname)) %>% dplyr::select(scientificname) %>% unique() %>% 
  arrange(scientificname) %>% data.frame()
# split the species into 2 or 3 plots depending on the number of unique species
# that has individual weights
if(nrow(species) <= 50){
  
  ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species$scientificname[1:floor((nrow(species)/2))] & !is.na(scientificname)),
         aes(x=length.cm, y=individualweight, group=scientificname)) +
    geom_point(size=3, shape="+", aes(colour=scientificname)) +guides(colour=FALSE)+
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
  
  ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species$scientificname[(floor((nrow(species)/2))+1):nrow(species)] & !is.na(scientificname)), 
         aes(x=length.cm, y=individualweight, group=scientificname)) +
    geom_point(size=3, shape="+", aes(colour=scientificname)) +guides(colour=FALSE)+
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
} else{
  ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species$scientificname[1:floor((nrow(species)/3))] & !is.na(scientificname)),
         aes(x=length.cm, y=individualweight, group=scientificname))+
    geom_point(size=3, shape="+", aes(colour=scientificname)) +guides(colour=FALSE)+
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
  
    ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species$scientificname[(floor((nrow(species)/3))+1):(floor((nrow(species)/3)*2))] & !is.na(scientificname)),
         aes(x=length.cm, y=individualweight, group=scientificname))+
    geom_point(size=3, shape="+", aes(colour=scientificname)) +guides(colour=FALSE)+
    facet_wrap(~scientificname, scales="free") + 
    labs(x="Length (cm)", y="Weight (kg)")+ theme_bw()
ggplot(stasampindiage %>% filter(individualweight>0 & scientificname %in% species$scientificname[(floor((nrow(species)/3)*2)+1):nrow(species)] & !is.na(scientificname)), 
       aes(x=length.cm, y=individualweight, group=scientificname)) +
  geom_point(size=3, shape="+", aes(colour=scientificname))+ guides(colour=FALSE) +
  facet_wrap(~scientificname, scales="free") + 
  labs(x="Length (cm)", y="Weight (kg)")+ theme_bw() 
}
```

\pagebreak

## Length-age relationships

```{r, echo=FALSE, message=FALSE, fig.width=8, fig.height=5, out.width= "80%", warning=FALSE}
ggplot(stasampindiage %>% filter(age>0 & !is.na(scientificname)), aes(length.cm, age))+geom_point(size = 0.5)+facet_wrap(~scientificname, scales = "free")+
  theme_bw()+labs(x = "Length (cm)", y = "Age (years)")
```





